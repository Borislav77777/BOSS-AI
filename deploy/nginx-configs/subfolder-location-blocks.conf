# Boss AI Platform - Nginx location блоки для подпапки
# Добавить в существующий server блок для boss-ai.online
#
# Использование:
# 1. Скопировать location блоки в существующий конфиг
# 2. sudo nginx -t
# 3. sudo systemctl reload nginx

# ============================================
# LOCATION BLOCKS FOR SUBFOLDER
# ============================================

# Frontend (React приложение) в подпапке /app/
location /app/ {
    alias /var/www/boss-ai/frontend/dist/;
    try_files $uri $uri/ /app/index.html;

    # Заголовки безопасности
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Кэширование статических файлов
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Сжатие
        gzip_static on;
    }

    # Не кэшировать HTML файлы
    location ~* \.(html|htm)$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }
}

# API Gateway в подпапке /app/api
location /app/api {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;

    # Таймауты
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # CORS заголовки
    add_header Access-Control-Allow-Origin "https://boss-ai.online" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # Обработка preflight запросов
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "https://boss-ai.online";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain charset=UTF-8';
        add_header Content-Length 0;
        return 204;
    }
}

# WebSocket для Socket.IO в подпапке /app/socket.io/
location /app/socket.io/ {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket специфичные настройки
    proxy_buffering off;
    proxy_cache off;
    proxy_read_timeout 86400;
}

# Health check для подпапки
location /app/health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# ============================================
# ALTERNATIVE: DIFFERENT SUBFOLDER NAMES
# ============================================

# Если нужно использовать другое имя подпапки, замените /app/ на нужное:
#
# Для /boss-ai/:
# location /boss-ai/ { ... }
# location /boss-ai/api { ... }
# location /boss-ai/socket.io/ { ... }
#
# Для /platform/:
# location /platform/ { ... }
# location /platform/api { ... }
# location /platform/socket.io/ { ... }
# ============================================
# NOTES
# ============================================
# Требования:
# - Nginx с поддержкой proxy модулей
# - Node.js приложение на порту 3000
# - SSL сертификат для boss-ai.online
#
# Переменные окружения для приложения:
# VITE_API_BASE_URL=https://boss-ai.online/app/api
# VITE_TELEGRAM_BOT_USERNAME=OzonBossAi_bot
#
# Проверка:
# curl -I https://boss-ai.online/app/
# curl https://boss-ai.online/app/api/health
