# Boss AI Platform - Apache VirtualHost для поддомена
# Файл: /etc/apache2/sites-available/app.boss-ai.online.conf
#
# Активация:
# sudo a2ensite app.boss-ai.online
# sudo systemctl reload apache2

# ============================================
# HTTPS VIRTUALHOST
# ============================================

<VirtualHost *:443>
# Основные настройки
ServerName app.boss-ai.online
DocumentRoot /var/www/boss-ai/frontend/dist

# SSL конфигурация (используем существующий сертификат)
SSLEngine on
SSLCertificateFile /etc/letsencrypt/live/boss-ai.online/cert.pem
SSLCertificateKeyFile /etc/letsencrypt/live/boss-ai.online/privkey.pem
SSLCertificateChainFile /etc/letsencrypt/live/boss-ai.online/chain.pem

# SSL настройки безопасности
SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
SSLHonorCipherOrder off
SSLSessionTickets off

# ============================================
# FRONTEND CONFIGURATION
# ============================================

<Directory "/var/www/boss-ai/frontend/dist">
AllowOverride All
Require all granted
Options -Indexes +FollowSymLinks

# SPA routing - все запросы направляем на index.html
RewriteEngine On
RewriteBase /

# Обработка статических файлов
RewriteCond % {
    REQUEST_FILENAM
}
-f [OR]
RewriteCond % {
    REQUEST_FILENAM
}
-d
RewriteRule ^ - [L]

# Все остальные запросы направляем на index.html
RewriteRule ^index\.html$ - [L]
RewriteCond % {
    REQUEST_FILENAM
}
!-f
RewriteCond % {
    REQUEST_FILENAM
}
!-d
RewriteRule . /index.html [L]
</Directory>

# ============================================
# API GATEWAY PROXY
# ============================================

# Проксирование API запросов к Node.js API Gateway
ProxyPreserveHost On
ProxyPass /api/ http://localhost:3000/api/
ProxyPassReverse /api/ http://localhost:3000/api/

# ============================================
# WEBSOCKET PROXY
# ============================================

# Проксирование WebSocket соединений для Socket.IO
ProxyPass /socket.io/ ws://localhost:3000/socket.io/
ProxyPassReverse /socket.io/ ws://localhost:3000/socket.io/

# ============================================
# SECURITY HEADERS
# ============================================

# Заголовки безопасности
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# CORS заголовки
Header always set Access-Control-Allow-Origin "https://app.boss-ai.online"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
Header always set Access-Control-Allow-Credentials "true"

# ============================================
# CACHING
# ============================================

# Кэширование статических файлов
<LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
ExpiresActive On
ExpiresDefault "access plus 1 year"
Header set Cache-Control "public, immutable"
</LocationMatch>

# Не кэшировать HTML файлы
<LocationMatch "\.(html|htm)$">
ExpiresActive Off
Header set Cache-Control "no-cache, no-store, must-revalidate"
Header set Pragma "no-cache"
Header set Expires "0"
</LocationMatch>

# ============================================
# COMPRESSION
# ============================================

# Сжатие файлов
<IfModule mod_deflate.c>
AddOutputFilterByType DEFLATE text/plain
AddOutputFilterByType DEFLATE text/html
AddOutputFilterByType DEFLATE text/xml
AddOutputFilterByType DEFLATE text/css
AddOutputFilterByType DEFLATE application/xml
AddOutputFilterByType DEFLATE application/xhtml+xml
AddOutputFilterByType DEFLATE application/rss+xml
AddOutputFilterByType DEFLATE application/javascript
AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# ============================================
# LOGGING
# ============================================

# Логирование
ErrorLog $ {
    APACHE_LOG_DI
}
/app.boss-ai.online_error.log
CustomLog $ {
    APACHE_LOG_DI
}
/app.boss-ai.online_access.log combined

# Логирование прокси запросов
LogFormat "%h %l %u %t \"%r\" %>s %O \"% {
    Refere
}
i\#$#%#$#placeholder23434#$#%#$#%{User-Agent}i\"" proxy
CustomLog $ {
    APACHE_LOG_DI
}
/app.boss-ai.online_proxy.log proxy
</VirtualHost>

# ============================================
# HTTP REDIRECT
# ============================================

<VirtualHost *:80>
ServerName app.boss-ai.online
Redirect permanent / https://app.boss-ai.online/
</VirtualHost>

# ============================================
# NOTES
# ============================================

# Требования:
# - mod_rewrite включен
# - mod_proxy включен
# - mod_proxy_http включен
# - mod_proxy_wstunnel включен (для WebSocket)
# - mod_headers включен
# - mod_deflate включен
# - mod_expires включен
#
# Команды для включения модулей:
# sudo a2enmod rewrite
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod proxy_wstunnel
# sudo a2enmod headers
# sudo a2enmod deflate
# sudo a2enmod expires
#
# Активация сайта:
# sudo a2ensite app.boss-ai.online
# sudo systemctl reload apache2
#
# Проверка конфигурации:
# sudo apache2ctl configtest
#
# DNS настройка:
# Добавить A-запись: app.boss-ai.online → 217.12.38.90
