# üìã –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï v3.0: Telegram Bot "–ö–∞—Ç—è" –¥–ª—è Boss AI Platform

### üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ù–∏–∫–æ–ª–∞–π

### üéØ –¶–µ–ª—å: –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ Telegram –±–æ—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É Boss AI

## üéØ –¶–ï–õ–¨ –ü–†–û–ï–ö–¢–ê

–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å **–ö–∞—Ç—é** –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Boss AI —Å —Ñ—É–Ω–∫—Ü–∏–µ–π **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –∫–æ–º–∞–Ω–¥—ã** (Institutional Knowledge), –∫–æ—Ç–æ—Ä—ã–π:

1. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ ChatGPT Service)
2. **–†–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:**

   - üì± Telegram Bot (–æ—Ç–≤–µ—á–∞–µ—Ç –≤ TG —á–∞—Ç–∞—Ö –Ω–∞ @–ö–∞—Ç—è)
   - üí¨ –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π —á–∞—Ç (–∫–Ω–æ–ø–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Boss AI)

3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-5 nano** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏ —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –±–∏–ª–ª–∏–Ω–≥–æ–º** —á–µ—Ä–µ–∑ service_pricing (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ BT)
5. **–ò–º–µ–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ** (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã AI)

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

### –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ Boss AI:

```
Boss AI Platform Services:
‚îú‚îÄ‚îÄ ChatGPT Service (frontend/public/services/chatgpt-service.json)
‚îú‚îÄ‚îÄ Ozon Manager Service
‚îú‚îÄ‚îÄ AI Lawyer Service
‚îú‚îÄ‚îÄ Photo Studio Service
‚îî‚îÄ‚îÄ NEW: Katya AI Service ‚≠ê
```

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ö–∞—Ç–∏ –∫–∞–∫ —Å–µ—Ä–≤–∏—Å–∞:

```
Katya AI Service
‚îú‚îÄ‚îÄ 1. Service Config (katya-service.json)
‚îÇ   ‚îú‚îÄ‚îÄ id: "katya-ai-service"
‚îÇ   ‚îú‚îÄ‚îÄ tools: [summarize, search, onboarding, decisions]
‚îÇ   ‚îú‚îÄ‚îÄ isChatFunction: true
‚îÇ   ‚îî‚îÄ‚îÄ chatApiEndpoint: "/api/katya/*"
‚îÇ
‚îú‚îÄ‚îÄ 2. Backend Microservice (Node.js + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ Express API Server (port 4300)
‚îÇ   ‚îú‚îÄ‚îÄ Telegram Bot Integration
‚îÇ   ‚îú‚îÄ‚îÄ GPT-5 nano Integration
‚îÇ   ‚îú‚îÄ‚îÄ Context Manager
‚îÇ   ‚îî‚îÄ‚îÄ Database Access (shared SQLite)
‚îÇ
‚îú‚îÄ‚îÄ 3. API Gateway Integration
‚îÇ   ‚îú‚îÄ‚îÄ Proxy: /api/katya/* ‚Üí http://localhost:4300
‚îÇ   ‚îú‚îÄ‚îÄ Authentication middleware
‚îÇ   ‚îî‚îÄ‚îÄ Billing middleware
‚îÇ
‚îú‚îÄ‚îÄ 4. Frontend Integration
‚îÇ   ‚îú‚îÄ‚îÄ Service button –≤ —á–∞—Ç–µ
‚îÇ   ‚îú‚îÄ‚îÄ Katya tools –≤ Service Sidebar
‚îÇ   ‚îú‚îÄ‚îÄ Settings panel –¥–ª—è –ö–∞—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ Chat history —Å –ö–∞—Ç–µ–π
‚îÇ
‚îî‚îÄ‚îÄ 5. Billing Integration
    ‚îú‚îÄ‚îÄ service_pricing —Ç–∞–±–ª–∏—Ü–∞
    ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ BT
    ‚îî‚îÄ‚îÄ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

---

## üìã –°–¢–†–£–ö–¢–£–†–ê –°–ï–†–í–ò–°–ê (katya-service.json)

```json
{
  "id": "katya-ai-service",
  "name": "–ö–∞—Ç—è AI",
  "description": "AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é –∫–æ–º–∞–Ω–¥—ã. –°—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∏—Å—Ç–æ—Ä–∏–∏, –ø–æ–º–æ–≥–∞–µ—Ç –Ω–æ–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.",
  "icon": "Brain",
  "version": "1.0.0",
  "isActive": true,
  "category": "ai",
  "priority": 2,
  "author": "BOSS AI Team",

  "settings": {
    "telegram_enabled": true,
    "platform_chat_enabled": true,
    "auto_summarize": true,
    "auto_summarize_threshold": 100,
    "context_window": 100,
    "ai_model": "gpt-5-nano",
    "billing_enabled": true
  },

  "tools": [
    {
      "id": "summarize-chat",
      "name": "üìä –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è",
      "description": "–ü–æ–¥–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–π –∏ –≤—ã–¥–µ–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è",
      "icon": "FileText",
      "action": "summarize",
      "isEnabled": true,
      "category": "analysis",
      "isChatFunction": true,
      "chatPrompt": "–ü–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è: {userInput}",
      "chatApiEndpoint": "/api/katya/summarize",
      "pricing": {
        "type": "per_request",
        "cost_bt": 0.5,
        "cost_rub": 5.0
      }
    },
    {
      "id": "search-history",
      "name": "üîç –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏",
      "description": "–ù–∞—Ö–æ–¥–∏—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ",
      "icon": "Search",
      "action": "search",
      "isEnabled": true,
      "category": "search",
      "isChatFunction": true,
      "chatPrompt": "–ù–∞–π–¥–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏: {userInput}",
      "chatApiEndpoint": "/api/katya/search",
      "pricing": {
        "type": "per_request",
        "cost_bt": 0.2,
        "cost_rub": 2.0
      }
    },
    {
      "id": "ask-katya",
      "name": "üí¨ –°–ø—Ä–æ—Å–∏—Ç—å –ö–∞—Ç—é",
      "description": "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∫–æ–º–∞–Ω–¥—ã",
      "icon": "MessageCircle",
      "action": "question",
      "isEnabled": true,
      "category": "chat",
      "isChatFunction": true,
      "chatPrompt": "{userInput}",
      "chatApiEndpoint": "/api/katya/question",
      "pricing": {
        "type": "per_request",
        "cost_bt": 0.3,
        "cost_rub": 3.0
      }
    },
    {
      "id": "show-decisions",
      "name": "‚úÖ –†–µ—à–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã",
      "description": "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π",
      "icon": "CheckCircle",
      "action": "decisions",
      "isEnabled": true,
      "category": "history",
      "isChatFunction": false,
      "apiEndpoint": "/api/katya/decisions",
      "pricing": {
        "type": "free",
        "cost_bt": 0,
        "cost_rub": 0
      }
    },
    {
      "id": "onboarding",
      "name": "üëã –û–Ω–±–æ—Ä–¥–∏–Ω–≥",
      "description": "–í–≤–æ–¥–Ω—ã–π –∫—É—Ä—Å –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã",
      "icon": "Users",
      "action": "onboarding",
      "isEnabled": true,
      "category": "help",
      "isChatFunction": true,
      "chatPrompt": "–†–∞—Å—Å–∫–∞–∂–∏ –æ –∫–æ–º–∞–Ω–¥–µ –∏ –ø—Ä–æ–µ–∫—Ç–µ",
      "chatApiEndpoint": "/api/katya/onboarding",
      "pricing": {
        "type": "free",
        "cost_bt": 0,
        "cost_rub": 0
      }
    },
    {
      "id": "katya-settings",
      "name": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–∞—Ç–∏",
      "description": "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç—ã –ö–∞—Ç–∏",
      "icon": "Settings",
      "action": "settings",
      "isEnabled": true,
      "category": "settings",
      "isChatFunction": false,
      "uiComponent": "KatyaSettings"
    }
  ],

  "endpoints": {
    "base": "/api/katya",
    "health": "/api/katya/health",
    "summarize": "/api/katya/summarize",
    "search": "/api/katya/search",
    "question": "/api/katya/question",
    "decisions": "/api/katya/decisions",
    "onboarding": "/api/katya/onboarding",
    "settings": "/api/katya/settings"
  },

  "telegram": {
    "enabled": true,
    "bot_username": "katya_boss_ai_bot",
    "commands": [
      { "command": "/summary", "description": "–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞" },
      { "command": "/search", "description": "–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏" },
      { "command": "/decisions", "description": "–°–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–∏–π" },
      { "command": "/onboarding", "description": "–í–≤–æ–¥–Ω—ã–π –∫—É—Ä—Å" }
    ],
    "mentions": ["@–ö–∞—Ç—è", "@Katya"]
  },

  "billing": {
    "service_name": "katya_ai",
    "pricing_items": [
      {
        "name": "katya_summarize",
        "description": "–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏–π",
        "unit_type": "request",
        "price_bt": 0.5,
        "price_rub": 5.0
      },
      {
        "name": "katya_search",
        "description": "–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏",
        "unit_type": "request",
        "price_bt": 0.2,
        "price_rub": 2.0
      },
      {
        "name": "katya_question",
        "description": "–í–æ–ø—Ä–æ—Å –∫ –ö–∞—Ç–µ",
        "unit_type": "request",
        "price_bt": 0.3,
        "price_rub": 3.0
      }
    ]
  }
}
```

---

## ü§ñ AI –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: GPT-5 NANO

### –ü–æ—á–µ–º—É GPT-5 nano?

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

1. ‚ö° **–°–∫–æ—Ä–æ—Å—Ç—å**: –í 3-5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ GPT-4 (–æ—Ç–≤–µ—Ç –∑–∞ 0.5-1 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 2-3 —Å–µ–∫)
2. üí∞ **–¶–µ–Ω–∞**: –í 10 —Ä–∞–∑ –¥–µ—à–µ–≤–ª–µ GPT-4 ($0.10/1M tokens vs $1.00/1M)
3. üéØ **–ö–∞—á–µ—Å—Ç–≤–æ**: –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. üìä **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –î–æ 128K —Ç–æ–∫–µ–Ω–æ–≤ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 100 —Å–æ–æ–±—â–µ–Ω–∏–π)
5. üåç **–†—É—Å—Å–∫–∏–π —è–∑—ã–∫**: –•–æ—Ä–æ—à–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ

**API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```typescript
// src/ai/gpt5-client.ts
import OpenAI from "openai";

export class GPT5NanoClient {
  private client: OpenAI;

  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey });
  }

  async summarize(
    messages: string[],
    context?: string
  ): Promise<SummaryResult> {
    const response = await this.client.chat.completions.create({
      model: "gpt-5-nano", // –∏–ª–∏ "gpt-4o-mini" –µ—Å–ª–∏ gpt-5-nano –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      messages: [
        {
          role: "system",
          content: `–¢—ã - –ö–∞—Ç—è, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Boss AI Team.
          –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã.
          –í—ã–¥–µ–ª–∏: —Ä–µ—à–µ–Ω–∏—è, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã, –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.
          –û—Ç–≤–µ—Ç –¥–∞–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ JSON.`,
        },
        {
          role: "user",
          content: `–°—É–º–º–∞—Ä–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:\n\n${messages.join(
            "\n"
          )}`,
        },
      ],
      temperature: 0.3, // –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
      max_tokens: 2000,
      response_format: { type: "json_object" },
    });

    return JSON.parse(response.choices[0].message.content);
  }

  async search(query: string, chatHistory: string[]): Promise<SearchResult> {
    const response = await this.client.chat.completions.create({
      model: "gpt-5-nano",
      messages: [
        {
          role: "system",
          content: `–¢—ã - –ö–∞—Ç—è. –ù–∞–π–¥–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å.
          –£–∫–∞–∂–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (message IDs) –∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç.`,
        },
        {
          role: "user",
          content: `–í–æ–ø—Ä–æ—Å: ${query}\n\n–ò—Å—Ç–æ—Ä–∏—è:\n${chatHistory.join("\n")}`,
        },
      ],
      temperature: 0.5,
      max_tokens: 1500,
    });

    return parseSearchResponse(response.choices[0].message.content);
  }
}
```

**Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**

```typescript
// –ï—Å–ª–∏ GPT-5 nano –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
const AI_MODEL_PRIORITY = [
  "gpt-5-nano", // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1
  "gpt-4o-mini", // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–¥–æ—Å—Ç—É–ø–µ–Ω —Å–µ–π—á–∞—Å)
  "claude-3-haiku", // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3
  "gemini-1.5-flash", // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4 (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
];
```

---

## üí∞ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ë–ò–õ–õ–ò–ù–ì–û–ú

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ service_pricing —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã –ö–∞—Ç–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞
INSERT OR IGNORE INTO service_pricing (service_name, unit_type, price_per_unit, currency, is_active) VALUES
  ('katya_summarize', 'request', 5.0, 'RUB', 1),
  ('katya_search', 'request', 2.0, 'RUB', 1),
  ('katya_question', 'request', 3.0, 'RUB', 1),
  ('katya_onboarding', 'request', 0.0, 'RUB', 1),
  ('katya_decisions', 'request', 0.0, 'RUB', 1);
```

### 2. Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

```typescript
// backend/main/src/middleware/katya-billing.middleware.ts
import { Request, Response, NextFunction } from "express";
import { BillingService } from "../services/billing.service";

const billingService = new BillingService(process.env.DB_PATH!);

// –ú–∞–ø–ø–∏–Ω–≥ endpoint ‚Üí service_name
const ENDPOINT_TO_SERVICE: Record<string, string> = {
  "/api/katya/summarize": "katya_summarize",
  "/api/katya/search": "katya_search",
  "/api/katya/question": "katya_question",
  "/api/katya/onboarding": "katya_onboarding",
  "/api/katya/decisions": "katya_decisions",
};

export async function katyaBillingMiddleware(
  req: Request,
  res: Response,
  next: NextFunction
) {
  const serviceName = ENDPOINT_TO_SERVICE[req.path];

  if (!serviceName) {
    return next();
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ service_pricing
  const pricing = await billingService
    .getServicePricing()
    .find((p) => p.service_name === serviceName);

  if (!pricing || pricing.price_per_unit === 0) {
    // –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    return next();
  }

  const userId = (req as any).user.id;

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
  const balance = await billingService.getBalance(userId);
  const balanceBT = balance.balance_bt;
  const requiredBT = pricing.price_per_unit / 10; // RUB to BT

  if (balanceBT < requiredBT) {
    return res.status(402).json({
      success: false,
      error: "Insufficient funds",
      message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è ${requiredBT} BT (${pricing.price_per_unit} ‚ÇΩ)`,
      balance: {
        current_bt: balanceBT,
        required_bt: requiredBT,
        deficit_bt: requiredBT - balanceBT,
      },
    });
  }

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  (req as any).katyaBilling = {
    serviceName,
    amount: pricing.price_per_unit,
    amountBT: requiredBT,
  };

  next();
}

// Middleware –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
export async function chargeAfterSuccess(
  req: Request,
  res: Response,
  next: NextFunction
) {
  const originalJson = res.json.bind(res);

  res.json = function (body: any) {
    const billing = (req as any).katyaBilling;

    if (billing && body.success) {
      // –°–ø–∏—Å–∞—Ç—å BT
      const userId = (req as any).user.id;
      billingService
        .charge(
          userId,
          billing.amount,
          billing.serviceName,
          `Katya AI: ${billing.serviceName}`
        )
        .catch((err) => {
          console.error("Billing error:", err);
        });
    }

    return originalJson(body);
  };

  next();
}
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ middleware –≤ API Gateway

```typescript
// backend/main/src/routes/katya.routes.ts
import express from "express";
import { authenticateToken } from "../middleware/auth.middleware";
import {
  katyaBillingMiddleware,
  chargeAfterSuccess,
} from "../middleware/katya-billing.middleware";
import { createKatyaProxy } from "../utils/proxy";

const router = express.Router();
const katyaProxy = createKatyaProxy(
  process.env.KATYA_SERVICE_URL || "http://localhost:4300"
);

// –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ö–∞—Ç–µ: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ ‚Üí –ø—Ä–æ–∫—Å–∏ ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ
router.use(
  "/api/katya/*",
  authenticateToken,
  katyaBillingMiddleware,
  chargeAfterSuccess,
  katyaProxy
);

export default router;
```

---

## üé® FRONTEND –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### 1. –ö–Ω–æ–ø–∫–∞ –ö–∞—Ç–∏ –≤ —á–∞—Ç–µ

```tsx
// frontend/src/components/Chat/ChatInput.tsx
import { Brain } from "lucide-react";

export function ChatInput() {
  const [showKatyaMenu, setShowKatyaMenu] = useState(false);

  return (
    <div className="chat-input-container">
      {/* –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –ö–∞—Ç–∏ */}
      <button
        onClick={() => setShowKatyaMenu(!showKatyaMenu)}
        className="katya-button"
        title="–ö–∞—Ç—è AI"
      >
        <Brain className="w-5 h-5" />
        <span>–ö–∞—Ç—è</span>
      </button>

      {/* –ú–µ–Ω—é –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–º–∞–Ω–¥ */}
      {showKatyaMenu && (
        <div className="katya-menu">
          <button onClick={() => executeKatyaTool("summarize")}>
            üìä –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
          </button>
          <button onClick={() => executeKatyaTool("search")}>üîç –ü–æ–∏—Å–∫</button>
          <button onClick={() => executeKatyaTool("decisions")}>
            ‚úÖ –†–µ—à–µ–Ω–∏—è
          </button>
          <button onClick={() => executeKatyaTool("onboarding")}>
            üëã –û–Ω–±–æ—Ä–¥–∏–Ω–≥
          </button>
        </div>
      )}

      {/* –û–±—ã—á–Ω—ã–π input */}
      <input type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ @–ö–∞—Ç—è –¥–ª—è –≤—ã–∑–æ–≤–∞..." />
    </div>
  );
}
```

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ö–∞—Ç–∏

```tsx
// frontend/src/components/Services/KatyaSettings.tsx
import { useState, useEffect } from "react";

interface KatyaSettings {
  telegram_enabled: boolean;
  platform_chat_enabled: boolean;
  auto_summarize: boolean;
  auto_summarize_threshold: number;
  context_window: number;
  ai_model: string;
}

export function KatyaSettings() {
  const [settings, setSettings] = useState<KatyaSettings | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchSettings();
  }, []);

  const fetchSettings = async () => {
    try {
      const token = localStorage.getItem("barsukov-token");
      const response = await fetch("/api/katya/settings", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      setSettings(data.settings);
    } catch (error) {
      console.error("Failed to load Katya settings:", error);
    } finally {
      setLoading(false);
    }
  };

  const updateSettings = async (newSettings: Partial<KatyaSettings>) => {
    try {
      const token = localStorage.getItem("barsukov-token");
      await fetch("/api/katya/settings", {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(newSettings),
      });
      setSettings({ ...settings!, ...newSettings });
    } catch (error) {
      console.error("Failed to update settings:", error);
    }
  };

  if (loading) return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

  return (
    <div className="katya-settings">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–∞—Ç–∏</h2>

      <div className="setting-group">
        <h3>ü§ñ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã</h3>

        <label>
          <input
            type="checkbox"
            checked={settings?.platform_chat_enabled}
            onChange={(e) =>
              updateSettings({ platform_chat_enabled: e.target.checked })
            }
          />
          –í–∫–ª—é—á–∏—Ç—å –ö–∞—Ç—é –≤ —á–∞—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        </label>

        <label>
          <input
            type="checkbox"
            checked={settings?.telegram_enabled}
            onChange={(e) =>
              updateSettings({ telegram_enabled: e.target.checked })
            }
          />
          Telegram –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω
        </label>
      </div>

      <div className="setting-group">
        <h3>üß† AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

        <label>
          –ú–æ–¥–µ–ª—å AI:
          <select
            value={settings?.ai_model}
            onChange={(e) => updateSettings({ ai_model: e.target.value })}
          >
            <option value="gpt-5-nano">GPT-5 nano (–±—ã—Å—Ç—Ä–æ, –¥–µ—à–µ–≤–æ)</option>
            <option value="gpt-4o-mini">GPT-4o mini (–±–∞–ª–∞–Ω—Å)</option>
            <option value="claude-3-haiku">Claude 3 Haiku</option>
          </select>
        </label>

        <label>
          –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
          <input
            type="number"
            value={settings?.context_window}
            onChange={(e) =>
              updateSettings({ context_window: parseInt(e.target.value) })
            }
            min="50"
            max="200"
          />
          —Å–æ–æ–±—â–µ–Ω–∏–π
        </label>
      </div>

      <div className="setting-group">
        <h3>üìä –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</h3>

        <label>
          <input
            type="checkbox"
            checked={settings?.auto_summarize}
            onChange={(e) =>
              updateSettings({ auto_summarize: e.target.checked })
            }
          />
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
        </label>

        {settings?.auto_summarize && (
          <label>
            –°—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ:
            <input
              type="number"
              value={settings?.auto_summarize_threshold}
              onChange={(e) =>
                updateSettings({
                  auto_summarize_threshold: parseInt(e.target.value),
                })
              }
              min="50"
              max="500"
            />
            —Å–æ–æ–±—â–µ–Ω–∏–π
          </label>
        )}
      </div>

      <div className="pricing-info">
        <h3>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
        <ul>
          <li>
            üìä –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è: <strong>0.5 BT</strong> (5 ‚ÇΩ)
          </li>
          <li>
            üîç –ü–æ–∏—Å–∫: <strong>0.2 BT</strong> (2 ‚ÇΩ)
          </li>
          <li>
            üí¨ –í–æ–ø—Ä–æ—Å: <strong>0.3 BT</strong> (3 ‚ÇΩ)
          </li>
          <li>
            ‚úÖ –†–µ—à–µ–Ω–∏—è: <strong>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</strong>
          </li>
          <li>
            üëã –û–Ω–±–æ—Ä–¥–∏–Ω–≥: <strong>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</strong>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

### 3. –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –ö–∞—Ç–µ–π

```tsx
// frontend/src/components/Services/KatyaHistory.tsx
export function KatyaHistory() {
  const [history, setHistory] = useState<KatyaMessage[]>([]);

  useEffect(() => {
    fetchHistory();
  }, []);

  const fetchHistory = async () => {
    const token = localStorage.getItem("barsukov-token");
    const response = await fetch("/api/katya/history", {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await response.json();
    setHistory(data.history);
  };

  return (
    <div className="katya-history">
      <h2>üìö –ò—Å—Ç–æ—Ä–∏—è —Å –ö–∞—Ç–µ–π</h2>
      {history.map((msg) => (
        <div key={msg.id} className="history-item">
          <div className="query">
            <strong>–í—ã:</strong> {msg.query}
          </div>
          <div className="response">
            <strong>–ö–∞—Ç—è:</strong> {msg.response}
          </div>
          <div className="meta">
            {new Date(msg.created_at * 1000).toLocaleString()} ¬∑{msg.cost_bt} BT
            ¬∑ {msg.service_name}
          </div>
        </div>
      ))}
    </div>
  );
}
```

---

## üîå BACKEND API ENDPOINTS

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Katya Service Backend

```
backend/katya-service/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                    # Express server (port 4300)
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ summarize.route.ts      # POST /summarize
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search.route.ts         # POST /search
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ question.route.ts       # POST /question
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decisions.route.ts      # GET /decisions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ onboarding.route.ts     # GET /onboarding
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.route.ts       # GET/PUT /settings
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history.route.ts        # GET /history
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.route.ts         # GET /health
‚îÇ   ‚îú‚îÄ‚îÄ telegram/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.ts                  # Telegram Bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mention.handler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ command.handler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message.handler.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keyboards.ts            # Inline keyboards
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gpt5-client.ts          # GPT-5 nano –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ summarizer.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search-engine.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts.ts
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ messages.repo.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ summaries.repo.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ contexts.repo.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ settings.repo.ts
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ context-manager.service.ts
‚îÇ       ‚îú‚îÄ‚îÄ knowledge-base.service.ts
‚îÇ       ‚îî‚îÄ‚îÄ telegram-bridge.service.ts
```

### API Endpoints (–ø—Ä–∏–º–µ—Ä—ã)

#### 1. POST /api/katya/summarize

```typescript
// –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏–π
router.post("/summarize", async (req, res) => {
  const { chatId, messageCount = 50, query } = req.body;
  const userId = (req as any).user.id;

  try {
    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
    const messages = await messagesRepo.getLastMessages(chatId, messageCount);

    // –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ GPT-5 nano
    const summary = await gpt5Client.summarize(messages, query);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å summary –≤ –ë–î
    await summariesRepo.create({
      chatId,
      summaryText: summary.text,
      messageCount: messages.length,
      keywords: summary.keywords,
    });

    res.json({
      success: true,
      data: {
        summary: summary.text,
        topics: summary.topics,
        decisions: summary.decisions,
        keywords: summary.keywords,
        message_count: messages.length,
      },
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

#### 2. POST /api/katya/search

```typescript
// –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
router.post("/search", async (req, res) => {
  const { query, chatId, limit = 10 } = req.body;

  try {
    // –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    const knowledgeResults = await knowledgeRepo.search(query);

    // –ü–æ–∏—Å–∫ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö
    const contextResults = await contextsRepo.search(query, chatId);

    // –ü–æ–∏—Å–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    const messageResults = await messagesRepo.search(query, chatId, limit);

    // –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å
    const results = rankResults([
      ...knowledgeResults,
      ...contextResults,
      ...messageResults,
    ]);

    res.json({
      success: true,
      data: {
        results,
        total: results.length,
      },
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

#### 3. POST /api/katya/question

```typescript
// –í–æ–ø—Ä–æ—Å –∫ –ö–∞—Ç–µ
router.post("/question", async (req, res) => {
  const { question, chatId } = req.body;

  try {
    // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const context = await contextManager.getRelevantContext(question, chatId);

    // –ó–∞–ø—Ä–æ—Å –∫ GPT-5 nano
    const answer = await gpt5Client.answer(question, context);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ knowledge base
    await knowledgeRepo.create({
      question,
      answer: answer.text,
      sourceChatId: chatId,
      sourceMessageIds: answer.sources,
    });

    res.json({
      success: true,
      data: {
        answer: answer.text,
        sources: answer.sources,
        confidence: answer.confidence,
      },
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

---

## üì± TELEGRAM –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### Dual Mode: Platform + Telegram

**–ö–∞—Ç—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:**

1. **Platform Mode** - –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —á–∞—Ç–µ Boss AI
2. **Telegram Mode** - –æ—Ç–≤–µ—á–∞–µ—Ç –≤ TG —á–∞—Ç–∞—Ö –Ω–∞ @–ö–∞—Ç—è

### Telegram Bot Handler

```typescript
// src/telegram/bot.ts
import TelegramBot from "node-telegram-bot-api";
import { GPT5NanoClient } from "../ai/gpt5-client";
import { MessagesRepository } from "../database/repositories/messages.repo";

export class KatyaTelegramBot {
  private bot: TelegramBot;
  private gpt5: GPT5NanoClient;
  private messagesRepo: MessagesRepository;

  constructor(token: string, gpt5ApiKey: string, dbPath: string) {
    this.bot = new TelegramBot(token, { polling: true });
    this.gpt5 = new GPT5NanoClient(gpt5ApiKey);
    this.messagesRepo = new MessagesRepository(dbPath);

    this.setupHandlers();
  }

  private setupHandlers() {
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    this.bot.on("message", async (msg) => {
      await this.messagesRepo.create({
        messageId: msg.message_id,
        chatId: msg.chat.id,
        telegramUserId: msg.from?.id,
        username: msg.from?.username,
        firstName: msg.from?.first_name,
        text: msg.text || "",
        isKatyaMention: this.isMentioned(msg.text),
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ @–ö–∞—Ç—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
    this.bot.on("message", async (msg) => {
      if (!this.isMentioned(msg.text)) return;

      try {
        // –ü–æ–∫–∞–∑–∞—Ç—å typing...
        await this.bot.sendChatAction(msg.chat.id, "typing");

        // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π)
        const messages = await this.messagesRepo.getLastMessages(
          msg.chat.id,
          50
        );

        // –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
        const summary = await this.gpt5.summarize(messages, msg.text);

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
        await this.bot.sendMessage(msg.chat.id, summary.text, {
          parse_mode: "Markdown",
          reply_to_message_id: msg.message_id,
          reply_markup: {
            inline_keyboard: [
              [
                {
                  text: "üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ",
                  callback_data: `details_${summary.id}`,
                },
                {
                  text: "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                  callback_data: `stats_${msg.chat.id}`,
                },
              ],
              [
                {
                  text: "üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
                  callback_data: `question_${msg.chat.id}`,
                },
              ],
            ],
          },
        });
      } catch (error) {
        await this.bot.sendMessage(msg.chat.id, `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${error.message}`, {
          reply_to_message_id: msg.message_id,
        });
      }
    });

    // –ö–æ–º–∞–Ω–¥—ã
    this.bot.onText(/\/summary/, (msg) => this.handleSummaryCommand(msg));
    this.bot.onText(/\/search (.+)/, (msg, match) =>
      this.handleSearchCommand(msg, match)
    );
    this.bot.onText(/\/decisions/, (msg) => this.handleDecisionsCommand(msg));
    this.bot.onText(/\/onboarding/, (msg) => this.handleOnboardingCommand(msg));
  }

  private isMentioned(text?: string): boolean {
    if (!text) return false;
    return (
      text.includes("@–ö–∞—Ç—è") ||
      text.includes("@Katya") ||
      text.includes("@katya_boss_ai_bot")
    );
  }

  private async handleSummaryCommand(msg: TelegramBot.Message) {
    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ @–ö–∞—Ç—è
  }

  // ... –¥—Ä—É–≥–∏–µ handlers
}
```

---

## üíæ –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–•–ï–ú–ê –ë–î

```sql
-- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
CREATE TABLE IF NOT EXISTS katya_requests (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  request_type TEXT NOT NULL,  -- 'summarize', 'search', 'question'
  request_data TEXT,            -- JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–ø—Ä–æ—Å–∞
  response_data TEXT,           -- JSON —Å –æ—Ç–≤–µ—Ç–æ–º
  cost_bt REAL NOT NULL,
  cost_rub REAL NOT NULL,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ö–∞—Ç–∏ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
CREATE TABLE IF NOT EXISTS katya_user_settings (
  user_id INTEGER PRIMARY KEY,
  telegram_enabled BOOLEAN DEFAULT 1,
  platform_chat_enabled BOOLEAN DEFAULT 1,
  auto_summarize BOOLEAN DEFAULT 1,
  auto_summarize_threshold INTEGER DEFAULT 100,
  context_window INTEGER DEFAULT 100,
  ai_model TEXT DEFAULT 'gpt-5-nano',
  updated_at INTEGER DEFAULT (strftime('%s', 'now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_katya_requests_user ON katya_requests(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_katya_requests_type ON katya_requests(request_type);
```

---

## ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ß–ï–ö–õ–ò–°–¢ –†–ê–ó–†–ê–ë–û–¢–ö–ò

### –≠—Ç–∞–ø 1: Service Config & Frontend (1-2 –¥–Ω—è)

- [ ] –°–æ–∑–¥–∞—Ç—å katya-service.json –ø–æ –æ–±—Ä–∞–∑—Ü—É chatgpt-service.json
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ö–∞—Ç–∏ –≤ ChatInput.tsx
- [ ] –°–æ–∑–¥–∞—Ç—å KatyaSettings.tsx –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å KatyaHistory.tsx –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å PlatformContext

### –≠—Ç–∞–ø 2: Backend Microservice Core (2-3 –¥–Ω—è)

- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express server (port 4300)
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î Boss AI (shared SQLite)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
- [ ] Endpoints: /summarize, /search, /question
- [ ] Health check endpoint

### –≠—Ç–∞–ø 3: GPT-5 Nano Integration (1 –¥–µ–Ω—å)

- [ ] GPT5NanoClient –∫–ª–∞—Å—Å
- [ ] –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
- [ ] –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
- [ ] –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
- [ ] Error handling & fallback

### –≠—Ç–∞–ø 4: Telegram Bot (2 –¥–Ω—è)

- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ (polling)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ chat_messages
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ @–ö–∞—Ç—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
- [ ] –ö–æ–º–∞–Ω–¥—ã /summary, /search, /decisions
- [ ] Inline keyboards –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

### –≠—Ç–∞–ø 5: Billing Integration (1-2 –¥–Ω—è)

- [ ] katyaBillingMiddleware –≤ API Gateway
- [ ] chargeAfterSuccess middleware
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å service_pricing
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
- [ ] –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤

### –≠—Ç–∞–ø 6: API Gateway Proxy (1 –¥–µ–Ω—å)

- [ ] –î–æ–±–∞–≤–∏—Ç—å /api/katya/\* —Ä–æ—É—Ç—ã –≤ API Gateway
- [ ] –ü—Ä–æ–∫—Å–∏ –∫ Katya Service (port 4300)
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å middleware (auth + billing)
- [ ] Health check –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –≠—Ç–∞–ø 7: PM2 & Deployment (1 –¥–µ–Ω—å)

- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM2 –¥–ª—è katya-service
- [ ] .env.example –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
- [ ] README.md –∏ INTEGRATION.md
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### –≠—Ç–∞–ø 8: Testing & Polish (2-3 –¥–Ω—è)

- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è AI —Ñ—É–Ω–∫—Ü–∏–π
- [ ] Integration —Ç–µ—Å—Ç—ã –¥–ª—è API
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–ª–∏–Ω–≥–∞
- [ ] UI/UX –ø–æ–ª–∏—Ä–æ–≤–∫–∞
- [ ] Performance —Ç–µ—Å—Ç—ã

---

## üì¶ DELIVERABLES

### 1. katya-service.tar.gz (–∞—Ä—Ö–∏–≤ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞)

```
katya-service/
‚îú‚îÄ‚îÄ dist/                  # Compiled JS
‚îú‚îÄ‚îÄ node_modules/          # Dependencies
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ INTEGRATION.md
```

### 2. katya-service.json (–¥–ª—è frontend/public/services/)

- Service configuration
- Tools definitions
- Billing settings
- Telegram config

### 3. INTEGRATION.md (–ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)

- SQL –º–∏–≥—Ä–∞—Ü–∏–∏
- PM2 configuration
- API Gateway setup
- Frontend integration
- Environment variables
- Testing checklist

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- API Documentation (endpoints, request/response)
- Telegram Commands Guide
- User Guide (–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ö–∞—Ç–µ–π)
- Admin Guide (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

---

## üéØ –ö–õ–Æ–ß–ï–í–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø V2.0

### –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å v1.0:

1. ‚úÖ **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–∞–∫ —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**

   - katya-service.json –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   - –ö–Ω–æ–ø–∫–∏ –≤ —á–∞—Ç–µ
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ

2. ‚úÖ **GPT-5 nano –≤–º–µ—Å—Ç–æ GPT-4**

   - –í 3-5x –±—ã—Å—Ç—Ä–µ–µ
   - –í 10x –¥–µ—à–µ–≤–ª–µ
   - –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

3. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∏–ª–ª–∏–Ω–≥**

   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ service_pricing
   - Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞
   - –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏

4. ‚úÖ **Dual Mode: Platform + Telegram**

   - –†–∞–±–æ—Ç–∞–µ—Ç –≤ —á–∞—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
   - –†–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram
   - –ï–¥–∏–Ω–∞—è –ë–î –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤

5. ‚úÖ **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**

   - KatyaSettings –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - KatyaHistory –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
   - –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤ —á–∞—Ç–µ

6. ‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î**

   - katya_requests –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
   - katya_user_settings –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üí° ROADMAP (–±—É–¥—É—â–∏–µ —Ñ–∏—á–∏)

### Phase 2 (–ø–æ—Å–ª–µ MVP):

- üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö –∏–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏–π
- üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã (/stats)
- üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ TODO
- üåê –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å

### Phase 3 (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ):

- üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —á–∞—Ç–∞–º–∏ (Slack, Discord)
- üìä Dashboard —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ä–µ—à–µ–Ω–∏–π
- ü§ñ ML –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π
- üîó API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

---

**–¢–ó –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏! üöÄ**

–í–æ–ø—Ä–æ—Å—ã –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è: @boss
